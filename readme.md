# ナローネットワークシミュレータ

低速回線をシミュレートすることができます


# 技術仕様

これはWebページを一文字ずつ送信するプロキシです。

言語はNodejsを利用しており、Windows/Linuxで動作を確認しています。

NodejsのTCPライブラリを利用しているので実際にTCPパケットに一文字ずつ載せて送れるかは実装依存になります。

## タイムアウト防止策

普通のプロキシであまりに遅い回線速度を設定するとタイムアウトしてしまいます。

これはTCPレベルで3 Way Handshakeが失敗しサーバーとの接続が確立できないからです。

しかしブラウザで制限をかけた場合はタイムアウトしません。

なぜならブラウザはサーバーとの接続を確立させた後、TCPより上位のレベルで速度を制限するためです。

#### 細かい計算の話

IPレベルの速度制限を設定したとき、限界は何bpsになるのでしょうか

あまりに回線が遅いとTCPのハンドシェイクが失敗しコネクションを確立出来ないため、TCPセグメントがタイムアウトしないギリギリが速度制限の限界です。

実際に計算してみましょう。

TCPのタイムアウト時間は21秒、TCPの最小セグメントサイズは IPヘッダ20Byte + TCPヘッダ20Byte = 40Byte になります。

復路も考えて42秒で40Byteのパケットを送信に必要な速度は、40 * 8 / 42 = 320bit / 42sec ≒ 7.62bps です。

つまり、7.62bpsの回線速度を下回らなければタイムアウトは起こりません。

## 自動設定

プロキシは「Wikipedia」のみプロキシさせる設定にしてあります。

Googleなどのサイトの速度には影響を与えません。

## 排他制御

HTTPサーバでは排他制御を組み込むことでシングルスレッドのように動作します。

つまり、ブラウザが複数のTCPコネクションを確立して並列にダウンロードするのを妨げます。

# 起動方法

```bash
npm i
npm run start
```

Windowsの設定→ネットワークとインターネット→プロキシ→セットアップスクリプトを使う→オンにしてスクリプトアドレスを`http://localhost:3002/abe.pac`に設定

以上でプロキシの設定は完了です
